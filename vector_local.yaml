api:
  enabled: true

sources:
  in:
    type: http_server
    address: 127.0.0.1:8000
    headers:
      - "*"

transforms:
  parse_json:
    type: remap
    inputs:
      - in
    source: |
      .message = parse_json!(string!(.message))

  normalize_logs:
    type: remap
    inputs:
      - parse_json
    source: |
      if exists(.request_id) {
        .log_type = "chat"
      } else {
        .log_type = "arena"
      }

  router:
    type: route
    inputs:
      - normalize_logs
    route:
      arena_logs: '.log_type == "arena"'
      chat_logs: '.log_type == "chat"'

  set_route_arena_logs:
    type: remap
    inputs:
      - router.arena_logs
    source: |
      .route = "arena_logs"

  set_route_chat:
    type: remap
    inputs:
      - router.chat_logs
    source: |
      .route = "chat"

sinks:
  console_out:
    type: console
    encoding:
      codec: json
    inputs:
      - set_route_arena_logs
      - set_route_chat
  file_out:
    type: file
    inputs:
      - set_route_arena_logs
      - set_route_chat
    path: "./local_logs/{{route}}/year=%Y/month=%m/day=%d/vector-%Y-%m-%d-%H.log"
    encoding:
      codec: json
    compression: none